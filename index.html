<!DOCTYPE html>
<html>
	<head>
		<title>MVT OL Debug</title>
		<link rel="stylesheet" href="http://openlayers.org/en/v3.18.2/css/ol.css" type="text/css">
		<script src="http://openlayers.org/en/v3.18.2/build/ol.js"></script>

		<script type="text/javascript">
			/***** MVT Config *****
				Change the following configuration options for your MVT instance
			*/
			var mvtConfig = {
				view:{
					// the map will initially center on this point 3857 projection/ Web Mercador
					center:[790793.4954921771, 6574927.869849075], // these values will center on Bonn, Germany
					zoom:14 // initial zoom level 1 for the furthest out and 20 for very zoomed in
				},
				layers:[
					// layer 1
					{
						controller:{
							pos:{top:10,right:10} // position of the features legend
						},
						// define your MVT endpoint
						url:'http://tegola.cfapps.io/maps/bonn_osm/{z}/{x}/{y}.vector.pbf'
					},
					{
						controller:{
							pos:{bottom:10,left:10}
						},
						url:'http://osm2vectortiles-3.tileserver.com/v2/{z}/{x}/{y}.pbf'
					}
					// additional layers may be added here as objects in the same format as layer 1
				]
			};
		</script>

		<style>
			.map {
				width:100%;
				height: 100%;
				position: absolute;
				background: #f8f4f0;
			}
		</style>
	</head>
	<body id="body">
		<div id="map" class="map"></div>
	</body>
	<script type="text/javascript">

		(function(){

			// colors from http://colorbrewer2.org/
			var colors = {
				greenBlue:[[247,252,253],[229,245,249],[204,236,230],[153,216,201],[102,194,164],[65,174,118],[35,139,69],[0,109,44],[0,68,27]],
				redPink:[[255,247,236],[254,232,200],[253,212,158],[253,187,132],[252,141,89],[239,101,72],[215,48,31],[179,0,0],[127,0,0]],
				blue:[[255,255,217],[237,248,177],[199,233,180],[127,205,187],[65,182,196],[29,145,192],[34,94,168],[37,52,148],[8,29,88]],
				brown:[[255,245,235],[254,230,206],[253,208,162],[253,174,107],[253,141,60],[241,105,19],[217,72,1],[166,54,3],[127,39,4]],
				green:[[247,252,245],[229,245,224],[199,233,192],[161,217,155],[116,196,118],[65,171,93],[35,139,69],[0,109,44],[0,68,27]],
				purple:[[252,251,253],[239,237,245],[218,218,235],[188,189,220],[158,154,200],[128,125,186],[106,81,163],[84,39,143],[63,0,125]],
				gray:[[255,255,255],[240,240,240],[217,217,217],[189,189,189],[150,150,150],[115,115,115],[82,82,82],[37,37,37],[0,0,0]],
				purplePink:[[255,247,243],[253,224,221],[252,197,192],[250,159,181],[247,104,161],[221,52,151],[174,1,126],[122,1,119],[73,0,106]],
				red:[[255,245,240],[254,224,210],[252,187,161],[252,146,114],[251,106,74],[239,59,44],[203,24,29],[165,15,21],[103,0,13]]
			};

			var stylesBase = {
				building:{fillColor:colors.gray[5]},
				debug:{strokeColor:colors.red[5],strokeWidth:1},
				farms:{fillColor:colors.green[3]},
				forest:{fillColor:colors.green[5]},
				grassland:{fillColor:colors.green[2]},
				lakes:{fillColor:colors.blue[5]},
				landuse:{fillColor:colors.gray[4].concat(0.3)},
				medical:{fillColor:colors.red[5]},
				military:{fillColor:colors.purplePink[5]},
				main_roads:{strokeColor:colors.purple[7],strokeWidth:2.5},
				residential:{fillColor:colors.red[4]},
				river:{fillColor:colors.blue[5]},
				road:{strokeColor:colors.purple[5],strokeWidth:1.5},
				sand:{fillColor:colors.brown[6]},
				schools:{fillColor:colors.red[6]},
				water:{fillColor:colors.blue[5]},
				
				alt1:{fillColor:colors.purplePink[3],strokeColor:colors.purplePink[4],strokeWidth:1},
				alt2:{fillColor:colors.greenBlue[3],strokeColor:colors.greenBlue[4],strokeWidth:1},
				alt3:{fillColor:colors.redPink[3],strokeColor:colors.redPink[4],strokeWidth:1},
				alt4:{fillColor:colors.gray[3],strokeColor:colors.gray[4],strokeWidth:1},
				alt5:{fillColor:colors.green[3],strokeColor:colors.green[4],strokeWidth:1},
			};

			var layers = [];

			var styles = {};
			var stylesInit = function(){
				for (var i in stylesBase){
					var style = stylesBase[i];
					styles[i] = styleGet(style);
				}
			};

			/*
			styleGet (fun): turns a simple style definition into an ol style
				style (obj):
					fillColor (ary): [r,g,b,a]
					strokeColor (ary): [r,g,b,a]
					strokeWidth (num): 
			*/
			var styleGet = function(style){
				var styleOL = {};
				if (style.fillColor){
					styleOL.fill = new ol.style.Fill({color:style.fillColor});
				}
				if (style.strokeColor){
					var stroke = {color:style.strokeColor};
					if (style.strokeWidth) stroke.width = stroke.strokeWidth;
					styleOL.stroke = new ol.style.Stroke(stroke);
				}
				return new ol.style.Style(styleOL);
			};

			/*
			controllersBuild (fun): builds OL layer controllers
			*/
			var controllersBuild = function(){
				for (var i=0,len=mvtConfig.layers.length;i<len;i++){
					var layerConfig = mvtConfig.layers[i];
					var layer = layers[i];
					if (layerConfig.controller){
						var con = layerConfig.controller
						con.pos = con.pos || {top:'10px',right:'10px'};
						var conDiv = document.createElement('div');
						conDiv.style.position = 'absolute';
						conDiv.style.width = '200px';
						conDiv.style.padding = '12px';
						conDiv.style.minHeight = '100px';
						conDiv.style.zIndex = '2000';
						conDiv.style.backgroundColor = '#fff';

						if (con.pos.top) conDiv.style.top = con.pos.top+'px';
						if (con.pos.bottom) conDiv.style.bottom = con.pos.bottom+'px';
						if (con.pos.left) conDiv.style.left = con.pos.left+'px';
						if (con.pos.right) conDiv.style.right = con.pos.right+'px';

						layers[i].controllerDiv = conDiv;

						document.getElementById('body').appendChild(conDiv);

						conDiv.addEventListener('click',function(event){
							var target = event.target || event.srcElement;
							var name = target.getAttribute('name');
							var layerInd = target.getAttribute('layerInd');
							if (layers[layerInd].featureLayers[name].render){
								layers[layerInd].featureLayers[name].render = false;
								target.style.backgroundColor = '#fff';
								target.style.color = '#333';
							} else {
								layers[layerInd].featureLayers[name].render = true;
								var color = target.getAttribute('bgColor');
								target.style.backgroundColor = color;
								target.style.color = '#fff';
							}
							layers[layerInd].layerOL.changed(); //trigger rerender
						});
					}
				}
			};

			var featureLayerTpl = document.createElement('div');
			featureLayerTpl.className = 'featureLayer';
			featureLayerTpl.style.font = 'Verdana,sans-serif';
			featureLayerTpl.style.lineHeight = '20px';
			featureLayerTpl.style.padding = '3px';
			featureLayerTpl.style.margin = '1px 0';
			featureLayerTpl.style.cursor = 'pointer';

			/*
			featureLayerBuild (fun): 
				featureLayer (obj):
					layerInd (num): index of layer in the layers array
					name (str): the name of the featureLayer
			*/
			var alt = 1; //tracks the alternate colors used (for variance)
			featureLayerBuild = function(featureLayer){
				if (!layers[featureLayer.layerInd].featureLayers) 
					layers[featureLayer.layerInd].featureLayers = {};

				if (!layers[featureLayer.layerInd].featureLayers[featureLayer.name] || !layers[featureLayer.layerInd].featureLayers[featureLayer.name].built){
					var featureDiv = featureLayerTpl.cloneNode();

					var nameText = document.createTextNode(featureLayer.name); 
  					featureDiv.appendChild(nameText);

  					featureDiv.setAttribute('name',featureLayer.name);
  					featureDiv.setAttribute('layerInd',featureLayer.layerInd);

					if (!stylesBase[featureLayer.name]){ // use alternate style
						styles[featureLayer.name] = styles['alt'+alt];
						stylesBase[featureLayer.name] = stylesBase['alt'+alt];
						alt++;
						if (alt > 5) alt = 1;
					}

					layers[featureLayer.layerInd].featureLayers[featureLayer.name] = layers[featureLayer.layerInd].featureLayers[featureLayer.name] || {};
					if (layers[featureLayer.layerInd].featureLayers[featureLayer.name].render === undefined)
						layers[featureLayer.layerInd].featureLayers[featureLayer.name].render = true;
					layers[featureLayer.layerInd].featureLayers[featureLayer.name].built = true;

					if (stylesBase[featureLayer.name]){
						var color = stylesBase[featureLayer.name].fillColor || stylesBase[featureLayer.name].strokeColor;
						//console.log('color:',color);
						if (color){
							var colorStr = 'rgb('+color[0]+','+color[1]+','+color[2]+')';
							
							featureDiv.setAttribute('bgColor',colorStr);

							if (layers[featureLayer.layerInd].featureLayers[featureLayer.name].render){
								featureDiv.style.backgroundColor = colorStr;
								featureDiv.style.color = '#fff';
							} else {
								featureDiv.style.backgroundColor = '#fff';
								featureDiv.style.color = '#333';
							}
							layers[featureLayer.layerInd].controllerDiv.appendChild(featureDiv);
						}

					}
				}
			};

			/*
			featureLayersReset (fun): resets the feature layers so that the legend can be rebuilt

			*/
			featureLayersReset = function(){
				//console.log('feature layer reset:',layers,styles,stylesBase);
				for (var i=0,len=layers.length;i<len;i++){
					for (var j in layers[i].featureLayers){
						layers[i].featureLayers[j].built = false;
					}
					layers[i].controllerDiv.innerHTML = '';
				}
			};


			/*
			style (fun): builds OL layer controllers
				ind (num): index of layer in layers
			*/
			var curResolution;
			var style = function(ind){
				return function(feature,resolution){
					if (resolution !== curResolution){
						featureLayersReset();
						curResolution = resolution;
					}
					var featureLayerStyles = [];
					var name = feature.get('layer');
					var type = feature.get('type');

					featureLayerBuild({
						layerInd:ind,
						name:name
					});

					if (layers[ind].featureLayers[name].render){
						if (styles[name]) featureLayerStyles.push(styles[name]);
					}
					return featureLayerStyles;
				};
			};

			stylesInit();

			var layersOL = [];
			for (var i=0,len=mvtConfig.layers.length;i<len;i++){
				var layerConfig = mvtConfig.layers[i];
				var layer = new ol.layer.VectorTile({
					source: new ol.source.VectorTile({
						attributions: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> ' +
						'© <a href="http://www.openstreetmap.org/copyright">' +
						'OpenStreetMap contributors</a>',
						format: new ol.format.MVT(),
						tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
						tilePixelRatio: 16,
						url:layerConfig.url
					}),
					style:style(i)
				});
				layersOL.push(layer);
				layers.push({layerOL:layer});
			}

			var map = new ol.Map({
				layers:layersOL,
				target:'map',
				view:new ol.View({
					center:mvtConfig.view.center,
					zoom:mvtConfig.view.zoom
				})
			});

			controllersBuild();
		})();
	</script>
</html>
